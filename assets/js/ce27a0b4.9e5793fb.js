"use strict";(self.webpackChunkinsect_totem=self.webpackChunkinsect_totem||[]).push([[6379],{28453:(e,n,l)=>{l.d(n,{R:()=>i,x:()=>t});var o=l(96540);const r={},s=o.createContext(r);function i(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:n},e.children)}},85972:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"PostgreSQL/Backup_Restore_BLOB_in_Postgres","title":"PostgreSQL Blob \u5099\u4efd\u8207\u56de\u5b58","description":"Backup and Restore BLOB in PostgreSQL","source":"@site/docs/140_PostgreSQL/Backup_Restore_BLOB_in_Postgres.md","sourceDirName":"140_PostgreSQL","slug":"/PostgreSQL/Backup_Restore_BLOB_in_Postgres","permalink":"/docs/PostgreSQL/Backup_Restore_BLOB_in_Postgres","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"PostgreSQL Blob \u5099\u4efd\u8207\u56de\u5b58","description":"Backup and Restore BLOB in PostgreSQL","keywords":["postgresql","lob","restore","backup"]},"sidebar":"totem_sidebar","previous":{"title":"\u4fe1\u4ef6\u9644\u4ef6\u4e2d\u6587\u6a94\u540d\u4e82\u78bc","permalink":"/docs/Mail/Mail_MimeUtility_Attatch_Garbled"},"next":{"title":"PostgreSQL Format JSONB Object","permalink":"/docs/PostgreSQL/JSONB/PostgreSQL_Format_JSONB_Object"}}');var r=l(74848),s=l(28453);const i={title:"PostgreSQL Blob \u5099\u4efd\u8207\u56de\u5b58",description:"Backup and Restore BLOB in PostgreSQL",keywords:["postgresql","lob","restore","backup"]},t="POSTGRESQL BLOB \u5099\u4efd\u8207\u56de\u5b58\u57fa\u672c\u7bc4\u4f8b",a={},d=[{value:"<strong>\u532f\u51fa</strong> \u55ae\u4e00 LOB \u6a94\u6848\u81f3\u6307\u5b9a\u4f4d\u7f6e\u7bc4\u4f8b<span></span>",id:"\u532f\u51fa-\u55ae\u4e00-lob-\u6a94\u6848\u81f3\u6307\u5b9a\u4f4d\u7f6e\u7bc4\u4f8b",level:2},{value:"<strong>\u532f\u5165</strong> \u55ae\u4e00\u6a94\u6848\u4e26\u53d6\u5f97 loid \u7bc4\u4f8b<span></span>",id:"\u532f\u5165-\u55ae\u4e00\u6a94\u6848\u4e26\u53d6\u5f97-loid-\u7bc4\u4f8b",level:2},{value:"\u542b BLOB COLUMN \u7684 TABLE \u5099\u4efd",id:"\u542b-blob-column-\u7684-table-\u5099\u4efd",level:2},{value:"\u67e5\u8a62 SCHEMA \u5c08\u6848\u4e0b\u7684 LOB \u7bc4\u4f8b",id:"\u67e5\u8a62-schema-\u5c08\u6848\u4e0b\u7684-lob-\u7bc4\u4f8b",level:2},{value:"\u67e5\u8a62 DORAEMON \u5c08\u6848\u7684 APPLICATION_FORM TABLE",id:"\u67e5\u8a62-doraemon-\u5c08\u6848\u7684-application_form-table",level:2},{value:"\u532f\u51fa TABLE APPLICATION_FORM \u7684 LOB OBJECT ID \u7bc4\u4f8b",id:"\u532f\u51fa-table-application_form-\u7684-lob-object-id-\u7bc4\u4f8b",level:2},{value:"\u532f\u5165 TABLE \u7684 LOB OBJECT ID \u7bc4\u4f8b",id:"\u532f\u5165-table-\u7684-lob-object-id-\u7bc4\u4f8b",level:2},{value:"\u6e05\u9664 DORAEMON \u672a\u4f7f\u7528\u7684 LOB",id:"\u6e05\u9664-doraemon-\u672a\u4f7f\u7528\u7684-lob",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5176\u4ed6\u53c3\u8003\u8cc7\u6599"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./Postgres_Export_Blob_to_File",children:"PostgreSQL \u532f\u51fa Blob \u6b04\u4f4d\u81f3\u6a94\u6848"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./Postgres_Import_Blob_from_File",children:"PostgreSQL \u4e0a\u50b3 Blob \u6a94\u6848"})}),"\n"]}),"\n",(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"postgresql-blob-\u5099\u4efd\u8207\u56de\u5b58\u57fa\u672c\u7bc4\u4f8b",children:"POSTGRESQL BLOB \u5099\u4efd\u8207\u56de\u5b58\u57fa\u672c\u7bc4\u4f8b"})}),"\n",(0,r.jsxs)(n.h2,{id:"\u532f\u51fa-\u55ae\u4e00-lob-\u6a94\u6848\u81f3\u6307\u5b9a\u4f4d\u7f6e\u7bc4\u4f8b",children:[(0,r.jsx)(n.strong,{children:"\u532f\u51fa"})," \u55ae\u4e00 LOB \u6a94\u6848\u81f3\u6307\u5b9a\u4f4d\u7f6e\u7bc4\u4f8b",(0,r.jsx)("span",{id:"single-clause-export"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"by select clause\r\nSELECT lo_export(index_file, '/tmp/download_file.csv') FROM table_with_lob_column\r\n\r\nby LOID / psql\r\npsql -U doraemon -d doraemon -c '\\lo_export given_oid /tmp/download_file.csv '\r\n\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"\u532f\u5165-\u55ae\u4e00\u6a94\u6848\u4e26\u53d6\u5f97-loid-\u7bc4\u4f8b",children:[(0,r.jsx)(n.strong,{children:"\u532f\u5165"})," \u55ae\u4e00\u6a94\u6848\u4e26\u53d6\u5f97 loid \u7bc4\u4f8b",(0,r.jsx)("span",{id:"single-clause-import"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5f8c\u7e8c\u9808\u518d\u5c07 OID \u6307\u5230\u5c0d\u61c9 table column"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"psql -U doraemon -d doraemon -c '\\lo_import /tmp/import_file.txt'\r\n\r\n----\r\nlo_import 123456\n"})}),"\n",(0,r.jsx)(n.h1,{id:"postgresql-blob-\u5099\u4efd\u8207\u56de\u5b58\u6279\u6b21",children:"PostgreSQL Blob \u5099\u4efd\u8207\u56de\u5b58(\u6279\u6b21)"}),"\n",(0,r.jsx)(n.p,{children:"\u7de3\u7531:"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Doraemon \u5c08\u6848\u7684 Application_Form table \u4e2d\u6709\u4f7f\u7528\u5230 blob \u6b04\u4f4d\u4f86\u5b58\u653e\u4e0a\u50b3\u6a94\u6848\u3002",(0,r.jsx)(n.br,{}),"\n","\u5728\u4f8b\u884c\u7684\u8cc7\u6599\u5eab\u5099\u4efd\u904e\u7a0b\u4e2d\u6703\u57f7\u884c pg_dump -t \u6307\u5b9a table \u5099\u4efd",(0,r.jsx)(n.br,{}),"\n","\u6b64\u6642 blob \u6703\u88ab\u7565\u904e\uff0c\u56e0\u6b64\u9700\u7279\u5225\u5c0d\u8a72 table \u8207 blob \u7279\u5225\u8655\u7406",(0,r.jsx)(n.br,{}),"\n","\u76f8\u95dc\u6b65\u9a5f\u5982\u4e0b:"]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5099\u4efd application_form table","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5728 pg_dump \u547d\u4ee4\u4e2d\u52a0\u5165 ",(0,r.jsx)(n.strong,{children:"-t application_form"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u532f\u51fa application_form \u4f7f\u7528\u5230\u7684 blob \u7684 lob object ID"}),"\n",(0,r.jsx)(n.li,{children:"\u56de\u5b58 application_form"}),"\n",(0,r.jsx)(n.li,{children:"\u5c0e\u5165\u4e8b\u5148\u5099\u4efd\u7684 blob \u4e26\u66f4\u65b0 application_form \u7684 loid (stands for: lob object id)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u542b-blob-column-\u7684-table-\u5099\u4efd",children:"\u542b BLOB COLUMN \u7684 TABLE \u5099\u4efd"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9700\u4f7f\u7528 pg_dump \u6307\u4ee4"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"pg_dump -t application_form\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u67e5\u8a62-schema-\u5c08\u6848\u4e0b\u7684-lob-\u7bc4\u4f8b",children:"\u67e5\u8a62 SCHEMA \u5c08\u6848\u4e0b\u7684 LOB \u7bc4\u4f8b"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u67e5\u8a62 DB \u6307\u5b9a Schema \u4e0b\u6240\u6709\u7684 LOB objects"}),"\n",(0,r.jsxs)(n.li,{children:["\u95dc\u9375\u5728\u65bc ",(0,r.jsx)(n.strong,{children:"pg_largeobject"})," \u9019\u500b\u5167\u5efa\u7684 table"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"psql -U postgres -d doraemon -c 'select loid from pg_largeobject'\n"})}),"\n",(0,r.jsx)(n.h1,{id:"doraemon-\u5c08\u6848\u532f\u51fa\u7bc4\u4f8b",children:"DORAEMON \u5c08\u6848\u532f\u51fa\u7bc4\u4f8b"}),"\n",(0,r.jsx)(n.h2,{id:"\u67e5\u8a62-doraemon-\u5c08\u6848\u7684-application_form-table",children:"\u67e5\u8a62 DORAEMON \u5c08\u6848\u7684 APPLICATION_FORM TABLE"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"psql -U postgres -d doraemon -c 'select id, file, file_name from application_form where file is not null order by id'\r\n\r\n id |   file   | file_name                \r\n\r\n----+----------+----------------------------------------\r\n\r\n  1 | 29990876 | application1.csv\r\n\r\n  2 | 29990875 | application2.csv\r\n\r\n  4 | 29990873 | application3.csv\r\n\n"})}),"\n",(0,r.jsx)(n.h1,{id:"lob-table-\u532f\u51fa\u4e26\u532f\u5165\u5230\u53e6\u4e00\u500b-table-\u7df4\u7fd2",children:"LOB TABLE \u532f\u51fa\u4e26\u532f\u5165\u5230\u53e6\u4e00\u500b TABLE \u7df4\u7fd2"}),"\n",(0,r.jsx)(n.h2,{id:"\u532f\u51fa-table-application_form-\u7684-lob-object-id-\u7bc4\u4f8b",children:"\u532f\u51fa TABLE APPLICATION_FORM \u7684 LOB OBJECT ID \u7bc4\u4f8b"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u8a3b(bash shell): eval is a built-in shell command used to evaluate and execute strings as a shell command."}),"\n",(0,r.jsxs)(n.li,{children:["\u5c07 pk, oid, filenmae \u4e32\u63a5\u5f8c\u7d44\u6210",(0,r.jsx)(n.a,{href:"#single-clause-export",children:"\u55ae\u4e00 BLOB \u6a94\u532f\u51fa\u53e5\u5b50"})]}),"\n",(0,r.jsx)(n.li,{children:"\u7d44\u6210 lo_export \u53e5\u5b50\u4ee5\u4f9b\u532f\u51fa\u6a94\u6848\u7528"}),"\n",(0,r.jsx)(n.li,{children:"\u5c07\u6a94\u6848\u532f\u51fa\u5230 lob \u8cc7\u6599\u593e\u4e4b\u4e0b(pk_filename.lob)"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",metastring:"shell",children:"for i in `psql -U doraemon -t -S -c \"select format('%s*%s*%s', id, file_name, file) from application_form where file is not null\"`;\r\n\r\ndo\r\n\r\n    eval $(echo $i | python3 -c \"import sys; id,filename,lobid=sys.stdin.read().split('*'); print('psql -U doraemon -c \\'\\\\lo_export %s /home/doraemon/download/lob/%s_%s.lob\\''%(lobid.strip(), id.strip(), filename.strip()))\");\r\n\r\ndone\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u532f\u5165-table-\u7684-lob-object-id-\u7bc4\u4f8b",children:"\u532f\u5165 TABLE \u7684 LOB OBJECT ID \u7bc4\u4f8b"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4f9d\u5e8f\u5c07\u6a94\u6848\u532f\u5165\u4e26\u4f9d\u5e8f\u53d6\u5f97\u6a94\u6848\u7684 LOID (lo_import \u51fd\u6578)"}),"\n",(0,r.jsxs)(n.li,{children:["\u53c3\u8003",(0,r.jsx)(n.a,{href:"#single-clause-import",children:"\u55ae\u4e00 BLOB \u6a94\u532f\u5165\u53e5\u5b50"})]}),"\n",(0,r.jsx)(n.li,{children:"\u5c07 LOID \u9935\u56de\u65b0\u7684 table record \u4e4b\u4e2d"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",metastring:"shell",children:'for f in `ls /home/doraemon/download/lob`;\r\n\r\ndo\r\n\r\n    psql -U doraemon -d doraemon -c "\\lo_import /home/doraemon/download/lob/$f" | python3 -c \'import sys;uid, _ = sys.argv[1].split("_", 1);print("update application_form set file = %s where id = %s" % (sys.stdin.read().replace("lo_import ", "").strip(), uid))\' $f | psql -U doraemon ;\r\n\r\ndone\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u6e05\u9664-doraemon-\u672a\u4f7f\u7528\u7684-lob",children:"\u6e05\u9664 DORAEMON \u672a\u4f7f\u7528\u7684 LOB"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4f7f\u7528 vacuumlo \u6307\u4ee4\uff0c\u7528\u4f86\u6e05\u9664 pg_largeobject \u7121\u4eba\u4f7f\u7528\u7684\u5b64\u5152\u8cc7\u6599\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"\r\nvacuumlo -U doraemon -v doraemon\r\n\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);