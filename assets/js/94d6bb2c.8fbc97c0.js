"use strict";(self.webpackChunkinsect_totem=self.webpackChunkinsect_totem||[]).push([[1003],{28453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>t});var r=s(96540);const i={},l=r.createContext(i);function c(e){const n=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(l.Provider,{value:n},e.children)}},74966:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>a,frontMatter:()=>c,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"PostgreSQL/JSONB/PostgreSQL_Size_Memory","title":"PostgreSQL Jsonb \u786c\u789f\u5360\u7528\u7a7a\u9593","description":"Jsonb \u8cc7\u6599\u6bd4\u6578\u8207\u8a18\u61b6\u9ad4\u5360\u7528\u8a08\u7b97","source":"@site/docs/140_PostgreSQL/JSONB/PostgreSQL_Size_Memory.md","sourceDirName":"140_PostgreSQL/JSONB","slug":"/PostgreSQL/JSONB/PostgreSQL_Size_Memory","permalink":"/docs/PostgreSQL/JSONB/PostgreSQL_Size_Memory","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"PostgreSQL Jsonb \u786c\u789f\u5360\u7528\u7a7a\u9593","description":"Jsonb \u8cc7\u6599\u6bd4\u6578\u8207\u8a18\u61b6\u9ad4\u5360\u7528\u8a08\u7b97","keywords":["postgresql","Jsonb","memory"]},"sidebar":"totem_sidebar","previous":{"title":"PostgreSQL JSONB \u5167\u5bb9\u7e2e\u6392","permalink":"/docs/PostgreSQL/JSONB/PostgreSQL_Format_JSONB_Object"},"next":{"title":"PostgreSQL \u5e73\u884c\u67e5\u8a62","permalink":"/docs/PostgreSQL/Parallel_Query_in_PostgreSQL"}}');var i=s(74848),l=s(28453);const c={title:"PostgreSQL Jsonb \u786c\u789f\u5360\u7528\u7a7a\u9593",description:"Jsonb \u8cc7\u6599\u6bd4\u6578\u8207\u8a18\u61b6\u9ad4\u5360\u7528\u8a08\u7b97",keywords:["postgresql","Jsonb","memory"]},t=void 0,o={},d=[{value:"\u7df4\u7fd2\u60c5\u5883",id:"\u7df4\u7fd2\u60c5\u5883",level:2},{value:"\u67e5\u8a62\u8cc7\u6599\u6240\u7ad9\u786c\u789f\u7a7a\u9593\u8a9e\u6cd5",id:"\u67e5\u8a62\u8cc7\u6599\u6240\u7ad9\u786c\u789f\u7a7a\u9593\u8a9e\u6cd5",level:2},{value:"\u8cc7\u6599\u8868\u4f54\u7528\u7a7a\u9593",id:"\u8cc7\u6599\u8868\u4f54\u7528\u7a7a\u9593",level:3},{value:"Jsonb \u6b04\u4f4d\u4f54\u7528\u7a7a\u9593",id:"jsonb-\u6b04\u4f4d\u4f54\u7528\u7a7a\u9593",level:3},{value:"\u6aa2\u8996 jsonb \u8cc7\u6599\u5167\u5bb9",id:"\u6aa2\u8996-jsonb-\u8cc7\u6599\u5167\u5bb9",level:2},{value:"\u53d6 json \u7269\u4ef6\u683c\u5f0f",id:"\u53d6-json-\u7269\u4ef6\u683c\u5f0f",level:3},{value:"table column \u683c\u5f0f",id:"table-column-\u683c\u5f0f",level:3},{value:"\u67e5\u8a62 jsonb \u6b04\u4f4d\u5167\u7684\u8cc7\u6599\u7b46\u6578",id:"\u67e5\u8a62-jsonb-\u6b04\u4f4d\u5167\u7684\u8cc7\u6599\u7b46\u6578",level:3},{value:"Jsonb \u53d6\u503c: String or Object",id:"jsonb-\u53d6\u503c-string-or-object",level:2},{value:"index \u8207 Json Key \u689d\u4ef6\u67e5\u8a62\u95dc\u806f",id:"index-\u8207-json-key-\u689d\u4ef6\u67e5\u8a62\u95dc\u806f",level:2}];function j(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["PostgreSQL 9.4 \u7248\u4e4b\u5f8c\u52a0\u5165 jsonb \u8cc7\u6599\u683c\u5f0f",(0,i.jsx)(n.br,{}),"\n","\u4ed6\u7684\u7f3a\u9ede\u662f ",(0,i.jsxs)("span",{style:{color:"#0044FF"},children:[" ",(0,i.jsx)(n.strong,{children:"\u6240\u4f54\u7684\u7a7a\u9593\u8f03\u5927"})," "]}),(0,i.jsx)(n.br,{}),"\n","\u4f46\u662f\u67e5\u8a62\u6bd4\u8f03\u6709\u6548\u7387\u4e14\u4e5f\u53ef\u5efa\u7acb index \u52a0\u901f\u67e5\u8a62",(0,i.jsx)(n.br,{}),"\n","\u53e6\u5916\uff0c\u56e0\u70ba jsonb \u6b04\u4f4d\u672c\u8eab\u7279\u6027\u662f ",(0,i.jsxs)("span",{style:{color:"#0044FF"},children:[" ",(0,i.jsx)(n.strong,{children:"\u4e0d\u6703\u9650\u5b9a table \u6b04\u4f4d\u500b\u6578"})," "]}),(0,i.jsx)(n.br,{}),"\n","\u6240\u4ee5\u7121\u6cd5\u76f4\u63a5\u770b\u51fa jsonb \u4e2d\u6b04\u4f4d\u7e3d\u6578\uff0c",(0,i.jsx)(n.br,{}),"\n","\u9808\u4ee5\u6307\u5b9a\u8a9e\u6cd5\u67e5\u8a62\u3002 \u4e0b\u9762\u7d00\u9304\u76f8\u95dc\u67e5\u8a62\u65b9\u5f0f"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u7df4\u7fd2\u60c5\u5883",children:"\u7df4\u7fd2\u60c5\u5883"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5047\u8a2d\u6709\u4e00\u500b\u5177 jsonb \u6b04\u4f4d\u7684 table \u5982\u4e0b"}),"\n",(0,i.jsx)(n.li,{children:"table \u7d00\u9304\u6a19\u672c\u8cc7\u8a0a\uff0cjson_data \u7528\u4f86\u8a18\u9304\u5206\u985e\u6a39\u8cc7\u6599\u3002"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"    --table: insect_specimen\r\n    create table insect_specimen (\r\n      id serial primary key, sample_id text, json_data jsonb   \r\n    );\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u67e5\u8a62\u8cc7\u6599\u6240\u7ad9\u786c\u789f\u7a7a\u9593\u8a9e\u6cd5",children:"\u67e5\u8a62\u8cc7\u6599\u6240\u7ad9\u786c\u789f\u7a7a\u9593\u8a9e\u6cd5"}),"\n",(0,i.jsx)(n.h3,{id:"\u8cc7\u6599\u8868\u4f54\u7528\u7a7a\u9593",children:"\u8cc7\u6599\u8868\u4f54\u7528\u7a7a\u9593"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"pg_table_size"})})," \u51fd\u5f0f: \u9019\u500b\u65b9\u6cd5\u6703\u56de\u50b3 table \u6240\u4f54\u7684\u786c\u789f\u7a7a\u9593\uff0c\u55ae\u4f4d\u70ba ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"bytes"})})]}),"\n",(0,i.jsx)(n.li,{children:"pg_size_pretty : \u8f49\u63db\u6210\u4eba\u985e\u53ef\u8b80\u7684\u683c\u5f0f\u3002 KB/MB/GM \u7b49"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"    --query table size\r\n    SELECT pg_size_pretty(pg_table_size('insect_specimen'));\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u4e0a\u8ff0\u67e5\u8a62\u4e5f\u53ef\u5728 psql \u4e0b\u67e5\u8a62"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"\\dt+"})})," \u6307\u4ee4\u9664\u4f54\u7528\u7a7a\u9593\u5916\u4e5f\u80fd\u67e5\u51fa\u5176\u4ed6 table \u5c6c\u6027","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)("code",{children:[(0,i.jsx)(n.strong,{children:"\\dt+"})," tableName"]})," \u6307\u4ee4\u7684\u610f\u601d"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"\\d"})})," : describe"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"t"})})," : table\uff0c\u50c5\u5217\u51fa table \u5c64\u7d1a\u7684\u8cc7\u8a0a\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"+"})})," : \u986f\u793a\u984d\u5916\u8cc7\u8a0a"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"../PostgreSQL_psql_misc#psql_dt_fun",children:"\\df \u6307\u4ee4\u53c3\u8003"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u8a3b:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"\\d+"})}),": \u7701\u7565 t \u53c3\u6578\uff0c\u5247\u53ef\u986f\u793a columns \u76f8\u95dc\u8cc7\u8a0a\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"    totem=> \\dt+ insect_specimen\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Result"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u8a3b: \u67b6\u69cb\u6a21\u5f0f = schema"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:" \u67b6\u69cb\u6a21\u5f0f  |       \u540d\u7a31       | \u578b\u5225   | \u64c1\u6709\u8005  |  \u5927\u5c0f   | \u63cf\u8ff0\r\n----------+-----------------+-------+--------+---------+------\r\n public   | insect_specimen | table | totem  | 5659 MB |\r\n \n"})}),"\n",(0,i.jsx)(n.h3,{id:"jsonb-\u6b04\u4f4d\u4f54\u7528\u7a7a\u9593",children:"Jsonb \u6b04\u4f4d\u4f54\u7528\u7a7a\u9593"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"pg_column_size"})})," \u51fd\u5f0f : \u9019\u500b\u65b9\u6cd5\u6703\u56de\u50b3 Jsonb Column \u6240\u4f54\u7684\u786c\u789f\u7a7a\u9593"]}),"\n",(0,i.jsxs)(n.li,{children:["\u642d\u914d ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"sum"})}),"\u3001",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"avg"})})," \u51fd\u5f0f\uff0c\u53ef\u8a08\u7b97\u6307\u5b9a Jsonb Column \u6240\u4f54\u7684\u7e3d/\u5e73\u5747\u786c\u789f\u7a7a\u9593"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"    --query jsonb column total size / average size\r\n    select\r\n      pg_size_pretty( sum(pg_column_size(json_data)) ) as json_total_size, \r\n      pg_size_pretty( avg(pg_column_size(json_data)) ) as json_average_size\r\n    from insect_specimen;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u6aa2\u8996-jsonb-\u8cc7\u6599\u5167\u5bb9",children:"\u6aa2\u8996 jsonb \u8cc7\u6599\u5167\u5bb9"}),"\n",(0,i.jsx)(n.h3,{id:"\u53d6-json-\u7269\u4ef6\u683c\u5f0f",children:"\u53d6 json \u7269\u4ef6\u683c\u5f0f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:'    select jsonb_pretty(json_data) from insect_specimen where id = 1;\r\n--\r\n{\r\n   "kingdom":\t"v1",\r\n   "phylum":\t"v2", \r\n   "class":\t"v3", \r\n   "order":\t"v4", \r\n   "family":\t"v5", \r\n   "genus":\t"v6", \r\n   "species":\t"v7"\r\n   ...\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"table-column-\u683c\u5f0f",children:"table column \u683c\u5f0f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:'    select t.key as Taxonomic_Ranks, t.value as Rank_Name\r\n        from insect_specimen q, jsonb_each_text(json_data) t \r\n        where q.id = 1;\r\n    \r\n--\r\n\r\n Taxonomic_Ranks | Rank_Name\r\n-----------------+--------\r\n              k1 | "v1"\r\n              k2 | "v2"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u67e5\u8a62-jsonb-\u6b04\u4f4d\u5167\u7684\u8cc7\u6599\u7b46\u6578",children:"\u67e5\u8a62 jsonb \u6b04\u4f4d\u5167\u7684\u8cc7\u6599\u7b46\u6578"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4ee5 jsonb_object_keys() \u5217\u51fa jsonb \u5167\u6240\u6709\u7684 json key\uff0c\u7136\u5f8c\u53bb\u52a0\u7e3d\u6578\u91cf"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"    select a.sample_id, count(t)\r\n        from insect_specimen a, jsonb_object_keys(a.json_data) t\r\n            group by a.sample_id\r\n            order by a.sample_id;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"jsonb-\u53d6\u503c-string-or-object",children:"Jsonb \u53d6\u503c: String or Object"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u6ce8\u610f","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u904b\u7b97\u7b26\u7684\u5dee\u7570\u3002"}),"\n",(0,i.jsxs)(n.li,{children:["\u6b64\u8655\u904b\u7b97\u7b26\u662f\u7528\u5728 ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"select value"})})," \u4e0a\u3002"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u67e5\u8a62 Jsonb value \u6642\uff0cPostgres \u56de\u50b3\u7684\u7a2e\u985e\u3002\u4f9d\u64da\u8a9e\u6cd5\u4e0d\u540c\u53ef\u80fd\u6703\u662f ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"String"})})," \u6216 ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"Jsonb Object"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"#>"})}),"\u3001",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"#>>"})})," : \u662f\u8a9e\u6cd5\u7cd6\uff0c\u5f8c\u9762\u63a5\u7684 argument \u662f ",(0,i.jsx)(n.em,{children:(0,i.jsx)(n.strong,{children:"\u968e\u5c64\u8def\u5f91"})})]}),"\n",(0,i.jsxs)(n.li,{children:["\u57fa\u672c\u4e0a: \u96d9\u7bad\u982d ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:">>"})})," \u53d6\u7684\u662f\u5167\u5bb9\u503c\uff0c\u55ae\u7bad\u982d ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:">"})})," \u53d6\u7684\u662f jsonb object"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"    -- -> return jsonb \r\n    select json_data -> 'kingdom' as kingdom\r\n        from insect_specimen where id = 1;\r\n     \r\n    -- #> return jsonb \r\n    select json_data #> '{\"kingdom\", \"phylum\"}' as phylum\r\n        from insect_specimen where id = 1;\r\n        \r\n    -- ->> return text \r\n    select json_data ->> 'kingdom' as kingdom\r\n        from insect_specimen where id = 1;\r\n\r\n    -- #>> return text\r\n    select json_data #>> '{\"kingdom\", \"phylum\"}' as phylum\r\n        from insect_specimen where id = 1;\r\n \n"})}),"\n",(0,i.jsx)(n.h2,{id:"index-\u8207-json-key-\u689d\u4ef6\u67e5\u8a62\u95dc\u806f",children:"index \u8207 Json Key \u689d\u4ef6\u67e5\u8a62\u95dc\u806f"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u6ce8\u610f","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u904b\u7b97\u7b26\u7684\u5dee\u7570\u3002"}),"\n",(0,i.jsxs)(n.li,{children:["\u6b64\u8655\u904b\u7b97\u7b26\u662f\u7528\u5728 ",(0,i.jsx)("code",{children:(0,i.jsx)(n.strong,{children:"where clause"})})," \u4e0a\u3002"]}),"\n",(0,i.jsx)(n.li,{children:"\u4e0d\u540c\u7a2e\u985e\u904b\u7b97\u7b26\u8207 index \u4e5f\u6709\u4e0d\u540c\u7a0b\u5ea6\u914d\u5408"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"    -- \u7528 '->' \u67e5\u8a62, \r\n    -- -> \u6548\u80fd: json key \u5206\u5225\u7522\u751f\u5e38\u7528\u7684 b-tree index\r\n    select * from insect_specimen\r\n        where json_data -> 'kingdom' is not null\r\n     \r\n    -- \u7528 '?' \u67e5\u8a62, \u9078\u51fa json_data \u5167\u5bb9\u6709 kingdom \u9019\u500b key \u7684\u8cc7\u6599\u5217\r\n    -- ? \u6548\u80fd:\u652f\u63f4 gin index\r\n    select * from insect_specimen\r\n        where json_data ? 'kingdom'\r\n     \r\n    -- \u7528 '@>' \u67e5\u8a62, \r\n    -- @> \u6548\u80fd: \u53ef\u4ee5\u7528 gin index\r\n    select count(*) from insect_specimen\r\n        where json_data @> '{\"kingdom\":\"v1\"}'\r\n     \r\n    --\u6e2c\u8a66: \u5efa\u7acb gin index, \u53ef\u7528\u5728 '?' \u6216 '@>' \u67e5\u8a62\r\n    --CREATE INDEX indexName ON tableName USING GIN (columnName);\r\n    CREATE INDEX idx_insect_specimen_gin ON insect_specimen USING GIN (json_data);\r\n   \r\n    --drop index idx_insect_specimen_gin;\r\n    analyze insect_specimen;\r\n    select * from pg_indexes where tablename = 'insect_specimen';\r\n     \r\n    select pg_size_pretty(pg_indexes_size('insect_specimen'));\n"})})]})}function a(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(j,{...e})}):j(e)}}}]);